name: ci

on:
  push:
  pull_request:

jobs:
  san:
    runs-on: ubuntu-latest
    container: fedora:rawhide
    name: san-${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: asan
            meson_sanitize: "address,undefined"
            extra_cflags: "-fsanitize-address-use-after-scope"
            runtime_env: |
              ASAN_OPTIONS=abort_on_error=1:detect_leaks=1:fast_unwind_on_malloc=0:detect_stack_use_after_return=1:strict_string_checks=1:check_initialization_order=1:detect_odr_violation=1
              UBSAN_OPTIONS=halt_on_error=1:print_stacktrace=1
          - name: ubsan
            meson_sanitize: "undefined"
            extra_cflags: ""
            runtime_env: |
              UBSAN_OPTIONS=halt_on_error=1:print_stacktrace=1
    env:
      CC: clang
      CXX: clang++
      LLVM_SYMBOLIZER_PATH: /usr/bin/llvm-symbolizer
      ASAN_SYMBOLIZER_PATH: /usr/bin/llvm-symbolizer
      CFLAGS: -O1 -g -fno-omit-frame-pointer -fno-optimize-sibling-calls -fno-sanitize-merge
      CXXFLAGS: -O1 -g -fno-omit-frame-pointer -fno-optimize-sibling-calls -fno-sanitize-merge
      LDFLAGS: -fuse-ld=lld
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          dnf -y update
          dnf -y install \
            clang llvm lld compiler-rt \
            git meson ninja-build pkgconf-pkg-config \
            libbpf-devel libxdp-devel

      - name: Configure
        run: |
          builddir="build-${{ matrix.name }}"
          export CFLAGS="${CFLAGS} ${{ matrix.extra_cflags }}"
          export CXXFLAGS="${CXXFLAGS} ${{ matrix.extra_cflags }}"
          meson setup "$builddir" \
            -D b_sanitize="${{ matrix.meson_sanitize }}" \
            -D b_lto=false \
            -D b_ndebug=false

      - name: Build
        run: meson compile -C "build-${{ matrix.name }}"

      - name: Test
        run: |
          set -euo pipefail
          eval "${{ matrix.runtime_env }}"
          if [ "${{ matrix.name }}" = "tsan" ]; then
            meson test -C "build-${{ matrix.name }}" --print-errorlogs --num-processes 1
          else
            meson test -C "build-${{ matrix.name }}" --print-errorlogs
          fi
